<!DOCTYPE html>
<html lang="uk" data-theme="dusk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title data-i18n="app_title">Lost Number — числова головоломка</title>
  
  <!-- CSS -->
  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/ui.css">
  <link rel="stylesheet" href="css/grid.css">
  <link rel="stylesheet" href="css/overlays.css">
  
  <!-- ErrorHandler конфигурация -->
  <script>
    // Глобальная конфигурация ErrorHandler
    window.ErrorHandlerConfig = {
      showUserMessages: true,
      logToConsole: true, // В разработке включено, в продакшне изменить на false
      collectStackTraces: true,
      maxErrorsPerMinute: 50,
      errorHistorySize: 100,
      onErrorReport: function(errorData) {
        // Функция для отправки ошибок на сервер/аналитику
        try {
          // Проверяем, находимся ли мы в продакшне
          const isProduction = !window.location.hostname.includes('localhost') && 
                              !window.location.hostname.includes('127.0.0.1') &&
                              !window.location.search.includes('dev=1');
          
          if (isProduction && navigator.sendBeacon && window.ANALYTICS_ENDPOINT) {
            // Отправляем только важные ошибки в продакшне
            const importantErrors = ['runtime', 'resource', 'promise', 'game_logic'];
            if (importantErrors.includes(errorData.meta?.type)) {
              const report = {
                id: errorData.id,
                type: errorData.meta?.type,
                message: errorData.message?.substring(0, 200),
                timestamp: errorData.timestamp,
                url: window.location.href
              };
              
              const blob = new Blob([JSON.stringify(report)], { type: 'application/json' });
              navigator.sendBeacon(window.ANALYTICS_ENDPOINT + '/error', blob);
            }
          }
        } catch (e) {
          // Тихий сбой - не логируем ошибку отправки
        }
      }
    };
  </script>
  
  <style>
    /* Стили для отображения критических ошибок */
    .critical-error {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 99999;
      padding: 20px;
      text-align: center;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      opacity: 0;
      animation: fadeIn 0.5s ease forwards;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .critical-error h2 {
      color: #ff6b9d;
      margin-bottom: 20px;
      font-size: 28px;
    }
    
    .critical-error p {
      max-width: 500px;
      margin-bottom: 30px;
      line-height: 1.5;
      font-size: 16px;
      color: #b8c1ec;
    }
    
    .critical-error button {
      background: linear-gradient(90deg, #ff6b9d 0%, #ff8e53 100%);
      color: white;
      border: none;
      padding: 12px 40px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 15px rgba(255, 107, 157, 0.3);
    }
    
    .critical-error button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 107, 157, 0.4);
    }
    
    .critical-error button:active {
      transform: translateY(0);
    }
    
    .critical-error .error-id {
      margin-top: 20px;
      font-size: 12px;
      color: #666;
      font-family: monospace;
    }
    
    /* Индикатор загрузки */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #1a1a2e;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 99998;
      transition: opacity 0.5s;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 3px solid transparent;
      border-top-color: #ff6b9d;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: #b8c1ec;
      font-size: 14px;
    }
  </style>
</head>

<body>
  <!-- Индикатор загрузки -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text" data-i18n="loading">Завантаження...</div>
  </div>

  <!-- Контейнер для критических ошибок -->
  <div id="criticalErrorContainer" class="critical-error" style="display: none;">
    <h2>⚠️ LostNumber</h2>
    <p id="criticalErrorMessage">Игра не может быть загружена. Пожалуйста, обновите страницу или попробуйте позже.</p>
    <button onclick="window.location.reload()">Обновить страницу</button>
    <div class="error-id" id="criticalErrorId"></div>
  </div>

  <div class="floating-hearts" id="floatingHearts"></div>

  <div class="victory-overlay hidden" id="victoryOverlay">
    <div class="victory-content">
      <div class="victory-title" data-i18n="victory_title"></div>
      <div class="victory-text" data-i18n="victory_text"></div>
      <div class="menu-buttons" style="margin-top:8px;">
        <button class="menu-btn primary" id="playAgainBtn" data-i18n="btn_play_again"></button>
        <button class="menu-btn secondary" id="backToMenuBtn" data-i18n="btn_back_to_menu"></button>
      </div>
    </div>
  </div>

  <div class="level-overlay hidden" id="levelOverlay">
    <div class="level-content">
      <div class="level-title" id="levelOverlayTitle" data-i18n="level_completed_title"></div>
      <div class="level-text" id="levelOverlayText"></div>
      <div class="level-stats" id="levelStats"></div>
      <div class="level-countdown" id="levelCountdown"></div>
      <div class="menu-buttons">
        <button class="menu-btn secondary" id="levelMenuBtn" data-i18n="btn_back_to_menu"></button>
        <button class="menu-btn primary" id="levelNextBtn" data-i18n="btn_next_level"></button>
      </div>
    </div>
  </div>

  <!-- КРАСИВОЕ КОЛЕСО ФОРТУНЫ -->
  <div class="wheel-overlay hidden" id="wheelOverlay">
    <div class="wheel-content">
      <div class="wheel-title" id="wheelTitle" data-i18n="wheel_title"></div>
      <div id="wheelXpLabel" class="wheel-xp"></div>
      <canvas id="fortuneWheel" width="300" height="300"></canvas>
      <div class="wheel-center-btn">
        <button id="spinWheelBtn" class="menu-btn primary" data-i18n="btn_spin_wheel"></button>
      </div>
      <div id="wheelResult" class="wheel-result"></div>
      <div class="wheel-daily-info" id="wheelDailyInfo"></div>
      <div class="menu-buttons" style="margin-top:10px;">
        <button class="menu-btn secondary" id="wheelCloseBtn" data-i18n="btn_close"></button>
      </div>
    </div>
  </div>

  <!-- ГЛАВНОЕ МЕНЮ -->
  <div class="screen main-menu" id="mainMenuScreen">
    <div class="game-logo">
      <span data-i18n="game_logo"></span>
    </div>
    
    <div class="menu-buttons">
      <button class="menu-btn primary" id="continueBtn" data-i18n="btn_continue"></button>
      <button class="menu-btn secondary" id="newGameBtn" data-i18n="btn_new_game"></button>
      <button class="menu-btn secondary" id="settingsBtn" data-i18n="btn_settings"></button>
      <button class="menu-btn secondary" id="dailyQuestsBtn" data-i18n="btn_daily_quests"></button>
      <button class="menu-btn secondary" id="achievementsBtn" data-i18n="btn_achievements"></button>
      <button class="menu-btn secondary" id="statsBtn" data-i18n="btn_stats"></button>
    </div>
  </div>

  <!-- ЭКРАН ДОСТИЖЕНИЙ -->
  <div class="screen achievements-screen hidden" id="achievementsScreen">
    <div class="settings-title" data-i18n="achievements_title"></div>
    <div class="achievements-grid" id="achievementsGrid"></div>
    <div class="menu-buttons back-btn-menu">
      <button class="menu-btn secondary" id="backFromAchievementsBtn" data-i18n="btn_back"></button>
    </div>
  </div>

  <!-- ЭКРАН СТАТИСТИКИ -->
  <div class="screen stats-screen hidden" id="statsScreen">
    <div class="settings-title" data-i18n="stats_title"></div>
    <div class="stats-grid" id="statsGrid"></div>
    <div class="menu-buttons back-btn-menu">
      <button class="menu-btn secondary" id="backFromStatsBtn" data-i18n="btn_back"></button>
    </div>
  </div>

  <!-- ЭКРАН ЕЖЕДНЕВНЫХ ЗАДАНИЙ -->
  <div class="screen daily-quests-screen hidden" id="dailyQuestsScreen">
    <div class="settings-title" data-i18n="daily_quests_title"></div>
    <div class="settings-options" id="dailyQuestsList"></div>
    <div class="menu-buttons back-btn-menu">
      <button class="menu-btn secondary" id="backFromDailyQuestsBtn" data-i18n="btn_back"></button>
    </div>
  </div>

  <!-- ИГРОВОЙ ЭКРАН -->
  <div class="screen game-screen hidden" id="gameScreen">
    <div class="goal-box">
      <span id="levelLabel"></span>
      <span data-i18n="goal_full"></span>
      <span id="targetValue"></span>    
    </div>

    <div class="xp-wrap">
      <div class="xp-multiplier-indicator" id="xpMultiplierIndicator"></div>
      <div class="xp-bar">
        <div class="xp-inner" id="xpBar"></div>
        <div class="xp-text" id="xpText"></div>
      </div>
    </div>

    <div class="bonuses">
      <div class="bonuses-left">
        <button class="bonus-btn" id="bonus-explosion" data-i18n-title="bonus_explosion_title">
          <span data-i18n="icon_bonus_explosion"></span> <span class="bonus-count" id="count-explosion">0</span>
        </button>
        <button class="bonus-btn" id="bonus-shuffle" data-i18n-title="bonus_shuffle_title">
          <span data-i18n="icon_bonus_shuffle"></span> <span class="bonus-count" id="count-shuffle">0</span>
        </button>
        <button class="bonus-btn" id="bonus-destroy" data-i18n-title="bonus_destroy_title">
          <span data-i18n="icon_bonus_destroy"></span> <span class="bonus-count" id="count-destroy">0</span>
        </button>
      </div>
      <div class="bonus-wheel-container">
        <button class="bonus-btn" id="bonus-wheel" data-i18n-title="bonus_wheel_title"><span data-i18n="icon_bonus_wheel"></span></button>
        <span class="bonus-count" id="wheelCostLabel">25</span>
        <span class="bonus-count" style="margin-left: 2px; color: var(--muted-color); font-size: 10px;" id="wheelRemainingSpins">(20)</span>
      </div>
    </div>  
  
    <div class="game-content">
      <div class="grid-container">
        <div class="grid" id="grid"></div>
        <div class="preview-bubble" id="previewBubble"></div>
      </div>
    </div>

    <div class="game-footer" id="gameFooter">
      <button class="footer-btn" id="footerHomeBtn" data-i18n-title="btn_home"><span data-i18n="icon_home"></span></button>
      <button class="footer-btn" id="footerSoundBtn" data-i18n-title="btn_sound"><span data-i18n="icon_sound"></span></button>
      <button class="footer-btn" id="footerSaveBtn" data-i18n-title="btn_save"><span data-i18n="icon_save"></span></button>
    </div> 
  </div>

  <!-- ЭКРАН НАСТРОЕК -->
  <div class="screen settings-screen hidden" id="settingsScreen">
    <div class="settings-title" data-i18n="settings_title"></div>
    <div class="settings-options">
      <div class="setting-item">
        <span class="setting-label" data-i18n="settings_animations_label"></span>
        <select class="setting-control" id="animationSelect">
          <option value="on" selected data-i18n="settings_animations_on"></option>
          <option value="off" data-i18n="settings_animations_off"></option>
        </select>
      </div>
      <div class="setting-item">
        <span class="setting-label" data-i18n="settings_sound_label"></span>
        <select class="setting-control" id="soundSelect">
          <option value="on" selected data-i18n="settings_sound_on"></option>
          <option value="off" data-i18n="settings_sound_off"></option>
        </select>
      </div>
      <div class="setting-item">
        <span class="setting-label" data-i18n="settings_theme_label"></span>
        <select class="setting-control" id="themeSelect">
          <option value="dawn" data-i18n="settings_theme_dawn"></option>
          <option value="dusk" data-i18n="settings_theme_dusk"></option>
        </select>
      </div>
      <div class="setting-item">
        <span class="setting-label" data-i18n="settings_language_label"></span>
        <select class="setting-control" id="languageSelect">
          <option value="ua" data-i18n="settings_language_ua"></option>
          <option value="ru" data-i18n="settings_language_ru"></option>
          <option value="en" data-i18n="settings_language_en"></option>
        </select>
      </div>
    </div>
    <div class="menu-buttons back-btn-menu">
      <button class="menu-btn primary" id="saveSettingsBtn" data-i18n="btn_save_settings"></button>
      <button class="menu-btn secondary" id="backFromSettingsBtn" data-i18n="btn_back"></button>
    </div>
  </div>

  <!-- ЭКРАН ОБ ИГРЕ -->
  <div class="screen settings-screen hidden" id="aboutScreen">
    <div class="settings-title" data-i18n="about_title"></div>
    <div class="settings-options">
      <div class="setting-item" style="text-align:center;">
        <p style="margin-bottom:10px;font-weight:700;" data-i18n="about_p1"></p>
        <p style="font-size:0.9rem;line-height:1.4;" data-i18n="about_p2"></p>
        <p style="margin-top:10px;font-size:0.9rem;line-height:1.4;" data-i18n="about_p3"></p>
      </div>
    </div>
    <div class="menu-buttons back-btn-menu">
      <button class="menu-btn secondary" id="backFromAboutBtn" data-i18n="btn_back"></button>
    </div>
  </div>

  <!-- JavaScript -->

  <!-- Core системы обработки ошибок -->
  <script src="js/system/errorHandler.js"></script>
  <script src="js/system/errorHandlerFallback.js"></script>
  
  <!-- Core игровые системы -->
  <script src="js/core/SeededRandom.js"></script>
  <script src="js/core/EventSystem.js"></script>
  <script src="js/core/ErrorBoundary.js"></script>
  <script src="js/core/NumberWeights.js"></script>
  <script src="js/core/GameCore.js"></script>
  <script src="js/core/Chain.js"></script>
  <script src="js/core/rules.js"></script>

  <!-- System модули -->
  <script src="js/system/debug.js"></script>
  <script src="js/system/analytics.js"></script>
  <script src="js/system/i18n.js"></script>
  <script src="js/system/storage.js"></script>
  <script src="js/system/audio.js"></script>
  <script src="js/system/platform.js"></script>

  <!-- Game модули -->
  <script src="js/game/state.js"></script>
  <script src="js/game/stats.js"></script>
  <script src="js/game/achievements.js"></script>
  <script src="js/game/bonuses.js"></script>
  <script src="js/game/wheel.js"></script>
  <script src="js/game/AntiStuckSystem.js"></script>
  <script src="js/game/MicroComboSystem.js"></script>
  <script src="js/game/DailyMoodSystem.js"></script>
  <script src="js/game/TutorSystem.js"></script>
  <script src="js/game/SmartFocusSystem.js"></script>
  <script src="js/game/daily.js"></script>
  <script src="js/game/grid.js"></script>

  <!-- UI модули -->
  <script src="js/ui/screens.js"></script>
  <script src="js/ui/menu.js"></script>
  <script src="js/ui/settings.js"></script>
  <script src="js/ui/overlays.js"></script>
  <script src="js/ui/DebugOverlay.js"></script>
  <script src="js/ui/PublicAchievements.js"></script>

  <!-- Главный файл игры -->
  <script src="js/main.js"></script>

  <!-- Глобальные обработчики ошибок и инициализация -->
  <script>
    // Глобальная функция для показа критических ошибок
    window.showCriticalError = function(message, errorId) {
      try {
        const errorContainer = document.getElementById('criticalErrorContainer');
        const errorMessage = document.getElementById('criticalErrorMessage');
        const errorIdElement = document.getElementById('criticalErrorId');
        
        if (errorContainer && errorMessage) {
          errorMessage.textContent = message || 'A critical error occurred. Please reload the page.';
          if (errorId && errorIdElement) {
            errorIdElement.textContent = 'Error ID: ' + errorId;
          }
          errorContainer.style.display = 'flex';
          
          // Скрываем все другие экраны
          document.querySelectorAll('.screen, .overlay').forEach(el => {
            if (el !== errorContainer) {
              el.style.display = 'none';
            }
          });
        }
      } catch (e) {
        console.error('Failed to show critical error:', e);
      }
    };
    
    // Скрываем индикатор загрузки
    function hideLoadingScreen() {
      try {
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
          loadingOverlay.style.opacity = '0';
          setTimeout(() => {
            loadingOverlay.style.display = 'none';
          }, 500);
        }
      } catch (e) {
        // Игнорируем ошибки при скрытии загрузки
      }
    }
    
    // Запуск игры при загрузке страницы
    window.addEventListener("DOMContentLoaded", () => {
      try {
        // Показываем индикатор загрузки
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
          loadingOverlay.style.display = 'flex';
        }
        
        // Даем время для загрузки ресурсов
        setTimeout(() => {
          try {
            // Инициализация игры
            window.game = new LostNumberGame();
            
            // Скрываем индикатор загрузки после инициализации
            hideLoadingScreen();
            
            // Логируем успешную инициализацию
            if (typeof ErrorHandler !== 'undefined') {
              ErrorHandler.info("Game initialized successfully");
            }
          } catch (error) {
            // Критическая ошибка при инициализации игры
            console.error("FATAL: Game failed to initialize", error);
            
            // Скрываем индикатор загрузки
            hideLoadingScreen();
            
            // Показываем сообщение об ошибке пользователю
            const errorId = error instanceof Error ? error.message : String(error).substring(0, 100);
            window.showCriticalError(
              "The game could not be loaded. Please refresh the page or try again later.",
              errorId
            );
            
            // Логируем ошибку если ErrorHandler доступен
            if (typeof ErrorHandler !== 'undefined') {
              ErrorHandler.handle(error, { type: 'fatal_init' });
            }
          }
        }, 100);
        
      } catch (error) {
        // Ошибка при установке обработчиков
        console.error("Failed to set up game initialization:", error);
        hideLoadingScreen();
        window.showCriticalError("Failed to set up the game. Please refresh the page.");
      }
    });
    
    // Обработчик ошибок ресурсов
    window.addEventListener('error', function(e) {
      if (e.target && (e.target.tagName === 'IMG' || e.target.tagName === 'SCRIPT' || e.target.tagName === 'LINK')) {
        console.warn('Resource failed to load:', e.target.src || e.target.href);
        // Можно добавить логику для замены сломанных ресурсов
      }
    }, true);
    
    // Обработчик для offline/online состояния
    window.addEventListener('online', function() {
      console.log('App is online');
      if (window.game && window.game.showMessage) {
        window.game.showMessage(window.game.t ? window.game.t("online_status") : "Back online");
      }
    });
    
    window.addEventListener('offline', function() {
      console.warn('App is offline');
      if (window.game && window.game.showMessage) {
        window.game.showMessage(window.game.t ? window.game.t("offline_status") : "Offline mode");
      }
    });
    
    // Предотвращаем закрытие страницы с несохраненными данными
    window.addEventListener('beforeunload', function(e) {
      if (window.game && window.game.hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
        return 'You have unsaved changes. Are you sure you want to leave?';
      }
    });
  </script>
</body>
</html>